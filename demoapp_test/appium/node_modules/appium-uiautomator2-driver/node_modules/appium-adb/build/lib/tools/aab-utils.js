"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger.js"));

var _path = _interopRequireDefault(require("path"));

var _support = require("@appium/support");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _helpers = require("../helpers.js");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _crypto = _interopRequireDefault(require("crypto"));

const AAB_CACHE = new _lruCache.default({
  max: 10,
  dispose: (hash, extractedFilesRoot) => _support.fs.rimraf(extractedFilesRoot)
});
const AAB_CACHE_GUARD = new _asyncLock.default();
const UNIVERSAL_APK = 'universal.apk';
const aabUtilsMethods = {};
process.on('exit', () => {
  if (!AAB_CACHE.size) {
    return;
  }

  const paths = [...AAB_CACHE.values()];

  _logger.default.debug(`Performing cleanup of ${paths.length} cached .aab ` + _support.util.pluralize('package', paths.length));

  for (const appPath of paths) {
    try {
      _support.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});

aabUtilsMethods.extractUniversalApk = async function extractUniversalApk(aabPath, opts = {}) {
  if (!(await _support.fs.exists(aabPath))) {
    throw new Error(`The file at '${aabPath}' either does not exist or is not accessible`);
  }

  const aabName = _path.default.basename(aabPath);

  const apkName = aabName.substring(0, aabName.length - _path.default.extname(aabName).length) + '.apk';
  const tmpRoot = await _support.tempDir.openDir();

  const tmpApksPath = _path.default.join(tmpRoot, `${aabName}.apks`);

  try {
    return await AAB_CACHE_GUARD.acquire(aabPath, async () => {
      const aabHash = await _support.fs.hash(aabPath);
      const {
        keystore,
        keystorePassword,
        keyAlias,
        keyPassword
      } = opts;
      let cacheHash = aabHash;

      if (keystore) {
        if (!(await _support.fs.exists(keystore))) {
          throw new Error(`The keystore file at '${keystore}' either does not exist ` + `or is not accessible`);
        }

        if (!keystorePassword || !keyAlias || !keyPassword) {
          throw new Error('It is mandatory to also provide keystore password, key alias, ' + 'and key password if the keystore path is set');
        }

        const keystoreHash = await _support.fs.hash(keystore);

        const keyAliasHash = _crypto.default.createHash('sha1');

        keyAliasHash.update(keyAlias);
        cacheHash = [cacheHash, keystoreHash, keyAliasHash.digest('hex')].join(':');
      }

      _logger.default.debug(`Calculated the cache key for '${aabPath}': ${cacheHash}`);

      if (AAB_CACHE.has(cacheHash)) {
        const resultPath = _path.default.resolve(AAB_CACHE.get(cacheHash), apkName);

        if (await _support.fs.exists(resultPath)) {
          return resultPath;
        }

        AAB_CACHE.del(cacheHash);
      }

      await this.initAapt2();
      const args = ['build-apks', '--aapt2', this.binaries.aapt2, '--bundle', aabPath, '--output', tmpApksPath, ...(keystore ? ['--ks', keystore, '--ks-pass', `pass:${keystorePassword}`, '--ks-key-alias', keyAlias, '--key-pass', `pass:${keyPassword}`] : []), '--mode=universal'];

      _logger.default.debug(`Preparing universal .apks bundle from '${aabPath}'`);

      await this.execBundletool(args, `Cannot build a universal .apks bundle from '${aabPath}'`);

      _logger.default.debug(`Unpacking universal application bundle at '${tmpApksPath}' to '${tmpRoot}'`);

      await (0, _helpers.unzipFile)(tmpApksPath, tmpRoot);
      let universalApkPath;
      const fileDeletionPromises = [];
      const allFileNames = await _support.fs.readdir(tmpRoot);

      for (const fileName of allFileNames) {
        const fullPath = _path.default.join(tmpRoot, fileName);

        if (fileName === UNIVERSAL_APK) {
          universalApkPath = fullPath;
        } else {
          fileDeletionPromises.push(_support.fs.rimraf(fullPath));
        }
      }

      try {
        await _bluebird.default.all(fileDeletionPromises);
      } catch (ign) {}

      if (!universalApkPath) {
        _logger.default.debug(`The following items were extracted from the .aab bundle: ${allFileNames}`);

        throw new Error(`${UNIVERSAL_APK} cannot be found in '${aabPath}' bundle. ` + `Does the archive contain a valid application bundle?`);
      }

      const resultPath = _path.default.join(tmpRoot, apkName);

      _logger.default.debug(`Found ${UNIVERSAL_APK} at '${universalApkPath}'. Caching it to '${resultPath}'`);

      await _support.fs.mv(universalApkPath, resultPath);
      AAB_CACHE.set(cacheHash, tmpRoot);
      return resultPath;
    });
  } catch (e) {
    await _support.fs.rimraf(tmpRoot);
    throw e;
  }
};

var _default = aabUtilsMethods;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBQUJfQ0FDSEUiLCJMUlUiLCJtYXgiLCJkaXNwb3NlIiwiaGFzaCIsImV4dHJhY3RlZEZpbGVzUm9vdCIsImZzIiwicmltcmFmIiwiQUFCX0NBQ0hFX0dVQVJEIiwiQXN5bmNMb2NrIiwiVU5JVkVSU0FMX0FQSyIsImFhYlV0aWxzTWV0aG9kcyIsInByb2Nlc3MiLCJvbiIsInNpemUiLCJwYXRocyIsInZhbHVlcyIsImxvZyIsImRlYnVnIiwibGVuZ3RoIiwidXRpbCIsInBsdXJhbGl6ZSIsImFwcFBhdGgiLCJyaW1yYWZTeW5jIiwiZSIsIndhcm4iLCJtZXNzYWdlIiwiZXh0cmFjdFVuaXZlcnNhbEFwayIsImFhYlBhdGgiLCJvcHRzIiwiZXhpc3RzIiwiRXJyb3IiLCJhYWJOYW1lIiwicGF0aCIsImJhc2VuYW1lIiwiYXBrTmFtZSIsInN1YnN0cmluZyIsImV4dG5hbWUiLCJ0bXBSb290IiwidGVtcERpciIsIm9wZW5EaXIiLCJ0bXBBcGtzUGF0aCIsImpvaW4iLCJhY3F1aXJlIiwiYWFiSGFzaCIsImtleXN0b3JlIiwia2V5c3RvcmVQYXNzd29yZCIsImtleUFsaWFzIiwia2V5UGFzc3dvcmQiLCJjYWNoZUhhc2giLCJrZXlzdG9yZUhhc2giLCJrZXlBbGlhc0hhc2giLCJjcnlwdG8iLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZGlnZXN0IiwiaGFzIiwicmVzdWx0UGF0aCIsInJlc29sdmUiLCJnZXQiLCJkZWwiLCJpbml0QWFwdDIiLCJhcmdzIiwiYmluYXJpZXMiLCJhYXB0MiIsImV4ZWNCdW5kbGV0b29sIiwidW56aXBGaWxlIiwidW5pdmVyc2FsQXBrUGF0aCIsImZpbGVEZWxldGlvblByb21pc2VzIiwiYWxsRmlsZU5hbWVzIiwicmVhZGRpciIsImZpbGVOYW1lIiwiZnVsbFBhdGgiLCJwdXNoIiwiQiIsImFsbCIsImlnbiIsIm12Iiwic2V0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL3Rvb2xzL2FhYi11dGlscy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IHVuemlwRmlsZSB9IGZyb20gJy4uL2hlbHBlcnMuanMnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuY29uc3QgQUFCX0NBQ0hFID0gbmV3IExSVSh7XG4gIG1heDogMTAsXG4gIGRpc3Bvc2U6IChoYXNoLCBleHRyYWN0ZWRGaWxlc1Jvb3QpID0+IGZzLnJpbXJhZihleHRyYWN0ZWRGaWxlc1Jvb3QpLFxufSk7XG5jb25zdCBBQUJfQ0FDSEVfR1VBUkQgPSBuZXcgQXN5bmNMb2NrKCk7XG5jb25zdCBVTklWRVJTQUxfQVBLID0gJ3VuaXZlcnNhbC5hcGsnO1xuXG5jb25zdCBhYWJVdGlsc01ldGhvZHMgPSB7fTtcblxucHJvY2Vzcy5vbignZXhpdCcsICgpID0+IHtcbiAgaWYgKCFBQUJfQ0FDSEUuc2l6ZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHBhdGhzID0gWy4uLkFBQl9DQUNIRS52YWx1ZXMoKV07XG4gIGxvZy5kZWJ1ZyhgUGVyZm9ybWluZyBjbGVhbnVwIG9mICR7cGF0aHMubGVuZ3RofSBjYWNoZWQgLmFhYiBgICtcbiAgICB1dGlsLnBsdXJhbGl6ZSgncGFja2FnZScsIHBhdGhzLmxlbmd0aCkpO1xuICBmb3IgKGNvbnN0IGFwcFBhdGggb2YgcGF0aHMpIHtcbiAgICB0cnkge1xuICAgICAgLy8gQXN5bmNocm9ub3VzIGNhbGxzIGFyZSBub3Qgc3VwcG9ydGVkIGluIG9uRXhpdCBoYW5kbGVyXG4gICAgICBmcy5yaW1yYWZTeW5jKGFwcFBhdGgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgfVxuICB9XG59KTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBBcGtDcmVhdGlvbk9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXlzdG9yZSBTcGVjaWZpZXMgdGhlIHBhdGggdG8gdGhlIGRlcGxveW1lbnQga2V5c3RvcmUgdXNlZFxuICogdG8gc2lnbiB0aGUgQVBLcy4gVGhpcyBmbGFnIGlzIG9wdGlvbmFsLiBJZiB5b3UgZG9uJ3QgaW5jbHVkZSBpdCxcbiAqIGJ1bmRsZXRvb2wgYXR0ZW1wdHMgdG8gc2lnbiB5b3VyIEFQS3Mgd2l0aCBhIGRlYnVnIHNpZ25pbmcga2V5LlxuICogSWYgdGhlIC5hcGsgaGFzIGJlZW4gYWxyZWFkeSBzaWduZWQgYW5kIGNhY2hlZCB0aGVuIGl0IGlzIG5vdCBnb2luZyB0byBiZSByZXNpZ25lZFxuICogdW5sZXNzIGEgZGlmZmVyZW50IGtleXN0b3JlIG9yIGtleSBhbGlhcyBpcyB1c2VkLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGtleXN0b3JlUGFzc3dvcmQgU3BlY2lmaWVzIHlvdXIga2V5c3RvcmXigJlzIHBhc3N3b3JkLlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5QWxpYXMgU3BlY2lmaWVzIHRoZSBhbGlhcyBvZiB0aGUgc2lnbmluZyBrZXkgeW91IHdhbnQgdG8gdXNlLlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5UGFzc3dvcmQgU3BlY2lmaWVzIHRoZSBwYXNzd29yZCBmb3IgdGhlIHNpZ25pbmcga2V5LlxuICogSXQgaXMgbWFuZGF0b3J5IHRvIHByb3ZpZGUgdGhpcyB2YWx1ZSBpZiBga2V5c3RvcmVgIG9uZSBpcyBhc3NpZ25lZFxuICogb3RoZXJ3aXNlIGl0IGlzIGdvaW5nIHRvIGJlIGlnbm9yZWQuXG4gKi9cblxuLyoqXG4gKiBCdWlsZHMgYSB1bml2ZXJzYWwgLmFwayBmcm9tIHRoZSBnaXZlbiAuYWFiIHBhY2thZ2UuIFNlZVxuICogaHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL2NvbW1hbmQtbGluZS9idW5kbGV0b29sI2dlbmVyYXRlX2Fwa3NcbiAqIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFhYlBhdGggRnVsbCBwYXRoIHRvIHRoZSBzb3VyY2UgLmFhYiBwYWNrYWdlXG4gKiBAcGFyYW0ge0Fwa0NyZWF0aW9uT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMgVGhlIHBhdGggdG8gdGhlIHJlc3VsdGluZyB1bml2ZXJzYWwgLmFway4gVGhlIC5hcGsgaXMgc3RvcmVkIGluIHRoZSBpbnRlcm5hbCBjYWNoZVxuICogYnkgZGVmYXVsdC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgY3JlYXRpbmcgdGhlIHVuaXZlcnNhbCAuYXBrXG4gKi9cbmFhYlV0aWxzTWV0aG9kcy5leHRyYWN0VW5pdmVyc2FsQXBrID0gYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFVuaXZlcnNhbEFwayAoYWFiUGF0aCwgb3B0cyA9IHt9KSB7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGFhYlBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZmlsZSBhdCAnJHthYWJQYXRofScgZWl0aGVyIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gIH1cblxuICBjb25zdCBhYWJOYW1lID0gcGF0aC5iYXNlbmFtZShhYWJQYXRoKTtcbiAgY29uc3QgYXBrTmFtZSA9IGFhYk5hbWUuc3Vic3RyaW5nKDAsIGFhYk5hbWUubGVuZ3RoIC0gcGF0aC5leHRuYW1lKGFhYk5hbWUpLmxlbmd0aCkgKyAnLmFwayc7XG4gIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgY29uc3QgdG1wQXBrc1BhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgYCR7YWFiTmFtZX0uYXBrc2ApO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBBQUJfQ0FDSEVfR1VBUkQuYWNxdWlyZShhYWJQYXRoLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhYWJIYXNoID0gYXdhaXQgZnMuaGFzaChhYWJQYXRoKTtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAga2V5c3RvcmUsXG4gICAgICAgIGtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgIGtleUFsaWFzLFxuICAgICAgICBrZXlQYXNzd29yZCxcbiAgICAgIH0gPSBvcHRzO1xuICAgICAgbGV0IGNhY2hlSGFzaCA9IGFhYkhhc2g7XG4gICAgICBpZiAoa2V5c3RvcmUpIHtcbiAgICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoa2V5c3RvcmUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUga2V5c3RvcmUgZmlsZSBhdCAnJHtrZXlzdG9yZX0nIGVpdGhlciBkb2VzIG5vdCBleGlzdCBgICtcbiAgICAgICAgICAgIGBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICAgICAgICB9XG4gICAgICAgIGlmICgha2V5c3RvcmVQYXNzd29yZCB8fCAha2V5QWxpYXMgfHwgIWtleVBhc3N3b3JkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJdCBpcyBtYW5kYXRvcnkgdG8gYWxzbyBwcm92aWRlIGtleXN0b3JlIHBhc3N3b3JkLCBrZXkgYWxpYXMsICcgK1xuICAgICAgICAgICAgJ2FuZCBrZXkgcGFzc3dvcmQgaWYgdGhlIGtleXN0b3JlIHBhdGggaXMgc2V0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qga2V5c3RvcmVIYXNoID0gYXdhaXQgZnMuaGFzaChrZXlzdG9yZSk7XG4gICAgICAgIGNvbnN0IGtleUFsaWFzSGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG4gICAgICAgIGtleUFsaWFzSGFzaC51cGRhdGUoa2V5QWxpYXMpO1xuICAgICAgICBjYWNoZUhhc2ggPSBbY2FjaGVIYXNoLCBrZXlzdG9yZUhhc2gsIGtleUFsaWFzSGFzaC5kaWdlc3QoJ2hleCcpXS5qb2luKCc6Jyk7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYENhbGN1bGF0ZWQgdGhlIGNhY2hlIGtleSBmb3IgJyR7YWFiUGF0aH0nOiAke2NhY2hlSGFzaH1gKTtcbiAgICAgIGlmIChBQUJfQ0FDSEUuaGFzKGNhY2hlSGFzaCkpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGgucmVzb2x2ZShBQUJfQ0FDSEUuZ2V0KGNhY2hlSGFzaCksIGFwa05hbWUpO1xuICAgICAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHJlc3VsdFBhdGgpKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdFBhdGg7XG4gICAgICAgIH1cbiAgICAgICAgQUFCX0NBQ0hFLmRlbChjYWNoZUhhc2gpO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmluaXRBYXB0MigpO1xuICAgICAgY29uc3QgYXJncyA9IFtcbiAgICAgICAgJ2J1aWxkLWFwa3MnLFxuICAgICAgICAnLS1hYXB0MicsIHRoaXMuYmluYXJpZXMuYWFwdDIsXG4gICAgICAgICctLWJ1bmRsZScsIGFhYlBhdGgsXG4gICAgICAgICctLW91dHB1dCcsIHRtcEFwa3NQYXRoLFxuICAgICAgICAuLi4oa2V5c3RvcmUgPyBbXG4gICAgICAgICAgJy0ta3MnLCBrZXlzdG9yZSxcbiAgICAgICAgICAnLS1rcy1wYXNzJywgYHBhc3M6JHtrZXlzdG9yZVBhc3N3b3JkfWAsXG4gICAgICAgICAgJy0ta3Mta2V5LWFsaWFzJywga2V5QWxpYXMsXG4gICAgICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke2tleVBhc3N3b3JkfWAsXG4gICAgICAgIF0gOiBbXSksXG4gICAgICAgICctLW1vZGU9dW5pdmVyc2FsJ1xuICAgICAgXTtcbiAgICAgIGxvZy5kZWJ1ZyhgUHJlcGFyaW5nIHVuaXZlcnNhbCAuYXBrcyBidW5kbGUgZnJvbSAnJHthYWJQYXRofSdgKTtcbiAgICAgIGF3YWl0IHRoaXMuZXhlY0J1bmRsZXRvb2woYXJncywgYENhbm5vdCBidWlsZCBhIHVuaXZlcnNhbCAuYXBrcyBidW5kbGUgZnJvbSAnJHthYWJQYXRofSdgKTtcblxuICAgICAgbG9nLmRlYnVnKGBVbnBhY2tpbmcgdW5pdmVyc2FsIGFwcGxpY2F0aW9uIGJ1bmRsZSBhdCAnJHt0bXBBcGtzUGF0aH0nIHRvICcke3RtcFJvb3R9J2ApO1xuICAgICAgYXdhaXQgdW56aXBGaWxlKHRtcEFwa3NQYXRoLCB0bXBSb290KTtcbiAgICAgIGxldCB1bml2ZXJzYWxBcGtQYXRoO1xuICAgICAgY29uc3QgZmlsZURlbGV0aW9uUHJvbWlzZXMgPSBbXTtcbiAgICAgIGNvbnN0IGFsbEZpbGVOYW1lcyA9IGF3YWl0IGZzLnJlYWRkaXIodG1wUm9vdCk7XG4gICAgICBmb3IgKGNvbnN0IGZpbGVOYW1lIG9mIGFsbEZpbGVOYW1lcykge1xuICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBhdGguam9pbih0bXBSb290LCBmaWxlTmFtZSk7XG4gICAgICAgIGlmIChmaWxlTmFtZSA9PT0gVU5JVkVSU0FMX0FQSykge1xuICAgICAgICAgIHVuaXZlcnNhbEFwa1BhdGggPSBmdWxsUGF0aDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaWxlRGVsZXRpb25Qcm9taXNlcy5wdXNoKGZzLnJpbXJhZihmdWxsUGF0aCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBCLmFsbChmaWxlRGVsZXRpb25Qcm9taXNlcyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICBpZiAoIXVuaXZlcnNhbEFwa1BhdGgpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaGUgZm9sbG93aW5nIGl0ZW1zIHdlcmUgZXh0cmFjdGVkIGZyb20gdGhlIC5hYWIgYnVuZGxlOiAke2FsbEZpbGVOYW1lc31gKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1VOSVZFUlNBTF9BUEt9IGNhbm5vdCBiZSBmb3VuZCBpbiAnJHthYWJQYXRofScgYnVuZGxlLiBgICtcbiAgICAgICAgICBgRG9lcyB0aGUgYXJjaGl2ZSBjb250YWluIGEgdmFsaWQgYXBwbGljYXRpb24gYnVuZGxlP2ApO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGguam9pbih0bXBSb290LCBhcGtOYW1lKTtcbiAgICAgIGxvZy5kZWJ1ZyhgRm91bmQgJHtVTklWRVJTQUxfQVBLfSBhdCAnJHt1bml2ZXJzYWxBcGtQYXRofScuIENhY2hpbmcgaXQgdG8gJyR7cmVzdWx0UGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy5tdih1bml2ZXJzYWxBcGtQYXRoLCByZXN1bHRQYXRoKTtcbiAgICAgIEFBQl9DQUNIRS5zZXQoY2FjaGVIYXNoLCB0bXBSb290KTtcbiAgICAgIHJldHVybiByZXN1bHRQYXRoO1xuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFhYlV0aWxzTWV0aG9kcztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxTQUFTLEdBQUcsSUFBSUMsaUJBQUosQ0FBUTtFQUN4QkMsR0FBRyxFQUFFLEVBRG1CO0VBRXhCQyxPQUFPLEVBQUUsQ0FBQ0MsSUFBRCxFQUFPQyxrQkFBUCxLQUE4QkMsV0FBQSxDQUFHQyxNQUFILENBQVVG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